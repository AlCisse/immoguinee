# ==========================================
# MAKEFILE LOCAL - TESTS LOCAUX
# ==========================================
# Commandes simplifi√©es pour tester en local
# ==========================================

.PHONY: help build up down restart logs status test clean

# Variables
COMPOSE_FILE := docker-compose.local.yml
COMPOSE := docker compose -f $(COMPOSE_FILE)

# ==========================================
# HELP
# ==========================================
help: ## Affiche l'aide
	@echo "üìö Makefile Tests Locaux - Immo Guin√©e"
	@echo ""
	@echo "Commandes disponibles :"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'

# ==========================================
# SETUP
# ==========================================
setup: ## Setup complet (premi√®re utilisation)
	@echo "üîß Setup complet..."
	@echo "1. Cr√©ation du fichier .env Laravel..."
	@cd backend && cp .env.example .env || true
	@echo "2. Cr√©ation du fichier .env Next.js..."
	@cd frontend/immoguinee && cp .env.local.example .env.local || true
	@echo "‚úÖ Setup termin√©! Vous pouvez maintenant lancer 'make build'"

laravel-setup: ## Initialise Laravel (apr√®s build et up)
	@echo "üîß Initialisation Laravel..."
	@chmod +x scripts/setup-laravel-local.sh
	@./scripts/setup-laravel-local.sh

# ==========================================
# DOCKER
# ==========================================
build: ## Build les images Docker
	@echo "üî® Building Docker images..."
	$(COMPOSE) build --no-cache
	@echo "‚úÖ Images built!"

up: ## D√©marre tous les services
	@echo "üöÄ Starting services..."
	$(COMPOSE) up -d
	@echo "‚è≥ Waiting for services to be healthy (30s)..."
	@sleep 30
	@echo "‚úÖ Services started!"
	@make status

down: ## Arr√™te tous les services
	@echo "üõë Stopping services..."
	$(COMPOSE) down
	@echo "‚úÖ Services stopped!"

restart: ## Red√©marre tous les services
	@echo "üîÑ Restarting services..."
	$(COMPOSE) restart
	@echo "‚úÖ Services restarted!"

status: ## Affiche le statut des services
	@echo "üìä Services status:"
	@$(COMPOSE) ps

logs: ## Affiche les logs (usage: make logs SERVICE=nginx)
	@if [ -z "$(SERVICE)" ]; then \
		$(COMPOSE) logs --tail=100 -f; \
	else \
		$(COMPOSE) logs --tail=100 -f $(SERVICE); \
	fi

# ==========================================
# LARAVEL
# ==========================================
laravel-shell: ## Acc√®de au shell Laravel
	@docker exec -it immo_local_app bash

laravel-migrate: ## Ex√©cute les migrations Laravel
	@echo "üóÉÔ∏è  Running Laravel migrations..."
	@docker exec immo_local_app php artisan migrate --force
	@echo "‚úÖ Migrations completed!"

laravel-seed: ## Seed la base de donn√©es
	@echo "üå± Seeding database..."
	@docker exec immo_local_app php artisan db:seed --force
	@echo "‚úÖ Database seeded!"

laravel-fresh: ## Reset et migre la base de donn√©es
	@echo "üîÑ Resetting database..."
	@docker exec immo_local_app php artisan migrate:fresh --seed --force
	@echo "‚úÖ Database reset!"

laravel-test: ## Lance les tests Laravel
	@echo "üß™ Running Laravel tests..."
	@docker exec immo_local_app php artisan test

# ==========================================
# DATABASE
# ==========================================
db-shell: ## Acc√®de au shell PostgreSQL
	@docker exec -it immo_local_postgres psql -U immo_user -d immo_guinee_db

db-reset: ## Reset la base de donn√©es
	@echo "üîÑ Resetting database..."
	@$(COMPOSE) stop postgres
	@docker volume rm immoguinee_postgres_local_data || true
	@$(COMPOSE) up -d postgres
	@sleep 10
	@make laravel-migrate
	@echo "‚úÖ Database reset!"

# ==========================================
# TESTS
# ==========================================
test: ## Ex√©cute tous les tests automatiques
	@echo "üß™ Running validation tests..."
	@./scripts/test-local.sh

test-quick: ## Tests rapides (health checks seulement)
	@echo "‚ö° Quick health checks..."
	@echo "Testing Nginx..."
	@curl -sf http://localhost:8080/health || echo "‚ùå Nginx failed"
	@echo "Testing Laravel API..."
	@curl -sf http://localhost:8080/api/health || echo "‚ùå Laravel failed"
	@echo "Testing Next.js..."
	@curl -sf http://localhost:3000/api/health || echo "‚ùå Next.js failed"
	@echo "‚úÖ Quick tests completed!"

health: ## V√©rifie la sant√© des services
	@echo "üè• Health check..."
	@curl -f http://localhost:8080/health && echo "‚úì Nginx OK" || echo "‚úó Nginx FAIL"
	@curl -f http://localhost:8080/api/health && echo "‚úì Laravel OK" || echo "‚úó Laravel FAIL"
	@curl -f http://localhost:3000/api/health && echo "‚úì Next.js OK" || echo "‚úó Next.js FAIL"

# ==========================================
# NETTOYAGE
# ==========================================
clean: ## Nettoie Docker (containers et volumes)
	@echo "üßπ Cleaning Docker..."
	$(COMPOSE) down -v
	@docker image prune -af
	@echo "‚úÖ Docker cleaned!"

clean-all: ## Nettoie tout (‚ö†Ô∏è supprime les images aussi)
	@echo "üßπ Cleaning everything..."
	$(COMPOSE) down -v
	@docker rmi immoguinee/laravel:local || true
	@docker rmi immoguinee/nextjs:local || true
	@docker system prune -af
	@echo "‚úÖ Everything cleaned!"

# ==========================================
# LOGS SP√âCIFIQUES
# ==========================================
logs-nginx: ## Logs Nginx
	@$(COMPOSE) logs --tail=100 -f nginx

logs-laravel: ## Logs Laravel
	@$(COMPOSE) logs --tail=100 -f app

logs-nextjs: ## Logs Next.js
	@$(COMPOSE) logs --tail=100 -f nextjs

logs-postgres: ## Logs PostgreSQL
	@$(COMPOSE) logs --tail=100 -f postgres

logs-redis: ## Logs Redis
	@$(COMPOSE) logs --tail=100 -f redis

logs-queue: ## Logs Queue Workers
	@$(COMPOSE) logs --tail=100 -f queue

# ==========================================
# STATS
# ==========================================
stats: ## Affiche les stats Docker
	@docker stats --no-stream

# ==========================================
# WORKFLOW COMPLET
# ==========================================
start-fresh: ## Workflow complet (premi√®re utilisation)
	@echo "üöÄ Starting fresh installation..."
	@make clean
	@make setup
	@make build
	@make up
	@sleep 10
	@make laravel-setup
	@make test-quick
	@echo ""
	@echo "‚úÖ Installation complete! Access:"
	@echo "  - Nginx: http://localhost:8080"
	@echo "  - Next.js: http://localhost:3000"
	@echo "  - API: http://localhost:8080/api/health"
	@echo ""

# ==========================================
# EXEMPLES D'UTILISATION
# ==========================================
# make setup          # Setup initial (premi√®re fois)
# make build          # Build les images
# make up             # D√©marre les services
# make status         # Voir le statut
# make logs           # Voir tous les logs
# make logs SERVICE=nginx  # Logs d'un service
# make test           # Tests complets
# make test-quick     # Tests rapides
# make health         # Health checks
# make laravel-migrate     # Migrer la BDD
# make clean          # Nettoyer
# make start-fresh    # Workflow complet

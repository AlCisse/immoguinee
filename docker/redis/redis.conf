# ==========================================
# REDIS CONFIGURATION - OPTIMISÉ POUR PRODUCTION
# Usage: Cache Laravel + Sessions + Queue Jobs
# VPS: 6 vCPU, 12GB RAM (Redis limité à 2GB)
# ==========================================

# ==========================================
# RÉSEAU ET CONNEXIONS
# ==========================================
bind 0.0.0.0
protected-mode yes
port 6379
tcp-backlog 511
timeout 300
tcp-keepalive 300

# ==========================================
# MÉMOIRE - Optimisé pour cache et sessions
# ==========================================
# Limite maximale de mémoire (2GB pour Redis)
maxmemory 2gb

# Politique d'éviction : allkeys-lru (supprime les clés les moins récemment utilisées)
# Options: volatile-lru, allkeys-lru, volatile-lfu, allkeys-lfu, volatile-random, allkeys-random, volatile-ttl, noeviction
maxmemory-policy allkeys-lru

# Nombre d'échantillons pour l'algorithme LRU/LFU
maxmemory-samples 5

# ==========================================
# PERSISTANCE - AOF (Append Only File)
# ==========================================
# Active la persistance AOF (plus sûr que RDB)
appendonly yes
appendfilename "appendonly.aof"

# Stratégie de synchronisation AOF
# Options: always (lent mais sûr), everysec (bon compromis), no (rapide mais risqué)
appendfsync everysec
no-appendfsync-on-rewrite no

# Réécriture automatique du fichier AOF
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# ==========================================
# PERSISTANCE - RDB (Snapshots)
# ==========================================
# Snapshots automatiques (backup)
# Sauvegarde si 1 changement en 15 minutes
save 900 1
# Sauvegarde si 10 changements en 5 minutes
save 300 10
# Sauvegarde si 10000 changements en 1 minute
save 60 10000

stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir /data

# ==========================================
# RÉPLICATION (si besoin de replica)
# ==========================================
# replica-read-only yes
# replica-serve-stale-data yes

# ==========================================
# SÉCURITÉ
# ==========================================
# Mot de passe Redis (à définir dans docker-compose)
# requirepass your_redis_password_here

# Commandes dangereuses désactivées
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command CONFIG ""
rename-command SHUTDOWN ""

# ==========================================
# CLIENTS ET PERFORMANCES
# ==========================================
# Nombre maximum de clients connectés
maxclients 10000

# ==========================================
# OPTIMISATIONS PERFORMANCES
# ==========================================
# Lazy freeing (libération asynchrone de la mémoire)
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes

# Active le threading I/O (améliore les performances)
io-threads 4
io-threads-do-reads yes

# Hash optimizations
hash-max-listpack-entries 512
hash-max-listpack-value 64

# Set optimizations
set-max-intset-entries 512
set-max-listpack-entries 128
set-max-listpack-value 64

# Zset optimizations
zset-max-listpack-entries 128
zset-max-listpack-value 64

# List optimizations
list-max-listpack-size -2
list-compress-depth 0

# ==========================================
# LOGGING
# ==========================================
loglevel notice
logfile ""

# ==========================================
# DATABASES
# ==========================================
databases 16

# Base 0 : Cache Laravel
# Base 1 : Sessions Laravel
# Base 2 : Queue Jobs Laravel
# Base 3-15 : Disponibles pour d'autres usages

# ==========================================
# SLOW LOG - Pour monitoring
# ==========================================
slowlog-log-slower-than 10000  # 10ms
slowlog-max-len 128

# ==========================================
# LATENCY MONITORING
# ==========================================
latency-monitor-threshold 100  # 100ms

# ==========================================
# NOTIFICATIONS (pour events)
# ==========================================
notify-keyspace-events ""

# ==========================================
# OPTIMISATIONS AVANCÉES
# ==========================================
# Active transparent huge pages
# Améliore les performances sur Linux
# (à configurer aussi au niveau de l'OS)
activedefrag yes
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10
active-defrag-threshold-upper 100
active-defrag-cycle-min 5
active-defrag-cycle-max 75

# ==========================================
# CLUSTER (désactivé pour instance unique)
# ==========================================
# cluster-enabled no

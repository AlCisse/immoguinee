# ==========================================
# POSTGRESQL CONFIGURATION - OPTIMISÉ POUR PRODUCTION
# VPS: 6 vCPU, 12GB RAM, 100GB NVMe
# ==========================================

# ==========================================
# CONNECTIONS ET AUTHENTIFICATION
# ==========================================
listen_addresses = '*'
max_connections = 100
superuser_reserved_connections = 3

# ==========================================
# MÉMOIRE - Optimisé pour 12GB RAM
# ==========================================
# shared_buffers : 25% de la RAM totale (3GB pour 12GB RAM)
shared_buffers = 3GB

# effective_cache_size : 50-75% de la RAM (6GB pour 12GB RAM)
# Indique à PostgreSQL combien de mémoire est disponible pour le cache
effective_cache_size = 6GB

# work_mem : Mémoire pour les opérations de tri et hash (32MB)
# Calculé comme (RAM * 0.25) / max_connections
work_mem = 32MB

# maintenance_work_mem : Mémoire pour VACUUM, CREATE INDEX, etc.
maintenance_work_mem = 512MB

# wal_buffers : Buffers pour Write-Ahead Logging
# 16MB recommandé pour de bonnes performances
wal_buffers = 16MB

# ==========================================
# PERFORMANCES DISQUE - Optimisé pour NVMe
# ==========================================
# random_page_cost : Coût des lectures aléatoires
# 1.1 pour SSD/NVMe (au lieu de 4.0 pour HDD)
random_page_cost = 1.1

# effective_io_concurrency : Nombre de requêtes I/O simultanées
# 200 pour NVMe (au lieu de 2 pour HDD)
effective_io_concurrency = 200

# checkpoint_completion_target : Étaler les checkpoints
checkpoint_completion_target = 0.9

# checkpoint_timeout : Intervalle entre les checkpoints automatiques
checkpoint_timeout = 15min

# max_wal_size : Taille maximale du WAL avant checkpoint forcé
max_wal_size = 2GB

# min_wal_size : Taille minimale du WAL à conserver
min_wal_size = 512MB

# ==========================================
# OPTIMISATIONS QUERY PLANNER
# ==========================================
# default_statistics_target : Précision des statistiques (100 par défaut)
default_statistics_target = 100

# ==========================================
# WRITE-AHEAD LOG (WAL)
# ==========================================
# wal_level : Niveau de logging (replica pour réplication)
wal_level = replica

# synchronous_commit : Commit synchrone (on pour sécurité)
# off pour meilleures performances mais risque de perte de données
synchronous_commit = on

# wal_compression : Compression du WAL
wal_compression = on

# wal_log_hints : Nécessaire pour certaines réplications
wal_log_hints = on

# ==========================================
# AUTOVACUUM - Maintenance automatique
# ==========================================
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 10s
autovacuum_vacuum_threshold = 50
autovacuum_vacuum_scale_factor = 0.05
autovacuum_analyze_threshold = 50
autovacuum_analyze_scale_factor = 0.05

# ==========================================
# LOGGING - Pour monitoring et debugging
# ==========================================
logging_collector = on
log_directory = 'pg_log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_truncate_on_rotation = on

# Log des requêtes lentes (> 1000ms)
log_min_duration_statement = 1000

# Log des erreurs
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_checkpoints = on
log_connections = on
log_disconnections = on
log_duration = off
log_lock_waits = on
log_temp_files = 0

# ==========================================
# PARALLÉLISATION - Optimisé pour 6 vCPU
# ==========================================
max_worker_processes = 6
max_parallel_workers_per_gather = 3
max_parallel_workers = 6
max_parallel_maintenance_workers = 3

# ==========================================
# SÉCURITÉ
# ==========================================
# Timeout pour les requêtes inactives
idle_in_transaction_session_timeout = 60000  # 60 secondes

# Timeout pour les statements
statement_timeout = 300000  # 5 minutes

# ==========================================
# LOCALE ET FORMATAGE
# ==========================================
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'

# Timezone
timezone = 'Africa/Conakry'

# ==========================================
# EXTENSIONS
# ==========================================
shared_preload_libraries = 'pg_stat_statements'

# Configuration pg_stat_statements
pg_stat_statements.max = 10000
pg_stat_statements.track = all

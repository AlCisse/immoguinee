# ==========================================
# MAKEFILE PRODUCTION - IMMO GUINÃ‰E
# ==========================================
# Commandes simplifiÃ©es pour gÃ©rer la production
# ==========================================

.PHONY: help build up down restart logs status clean backup monitor audit deploy

# Variables
COMPOSE_FILE := docker-compose.production.yml
COMPOSE := docker compose -f $(COMPOSE_FILE)

# ==========================================
# HELP
# ==========================================
help: ## Affiche l'aide
	@echo "ðŸ“š Makefile Production - Immo GuinÃ©e"
	@echo ""
	@echo "Commandes disponibles :"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'

# ==========================================
# DOCKER
# ==========================================
build: ## Build les images Docker
	@echo "ðŸ”¨ Building Docker images..."
	$(COMPOSE) build --no-cache

up: ## DÃ©marre tous les services
	@echo "ðŸš€ Starting services..."
	$(COMPOSE) up -d
	@echo "âœ… Services started!"
	@make status

down: ## ArrÃªte tous les services
	@echo "ðŸ›‘ Stopping services..."
	$(COMPOSE) down
	@echo "âœ… Services stopped!"

restart: ## RedÃ©marre tous les services
	@echo "ðŸ”„ Restarting services..."
	$(COMPOSE) restart
	@echo "âœ… Services restarted!"

status: ## Affiche le statut des services
	@echo "ðŸ“Š Services status:"
	@$(COMPOSE) ps

logs: ## Affiche les logs (usage: make logs SERVICE=nginx)
	@if [ -z "$(SERVICE)" ]; then \
		$(COMPOSE) logs --tail=100 -f; \
	else \
		$(COMPOSE) logs --tail=100 -f $(SERVICE); \
	fi

# ==========================================
# LARAVEL
# ==========================================
laravel-shell: ## AccÃ¨de au shell Laravel
	@docker exec -it immo_guinee_app_prod bash

laravel-migrate: ## ExÃ©cute les migrations Laravel
	@echo "ðŸ—ƒï¸  Running Laravel migrations..."
	@docker exec immo_guinee_app_prod php artisan migrate --force
	@echo "âœ… Migrations completed!"

laravel-cache: ## Cache toutes les configurations Laravel
	@echo "âš¡ Caching Laravel configurations..."
	@docker exec immo_guinee_app_prod php artisan config:cache
	@docker exec immo_guinee_app_prod php artisan route:cache
	@docker exec immo_guinee_app_prod php artisan view:cache
	@echo "âœ… Laravel cached!"

laravel-clear: ## Vide tous les caches Laravel
	@echo "ðŸ§¹ Clearing Laravel caches..."
	@docker exec immo_guinee_app_prod php artisan config:clear
	@docker exec immo_guinee_app_prod php artisan cache:clear
	@docker exec immo_guinee_app_prod php artisan route:clear
	@docker exec immo_guinee_app_prod php artisan view:clear
	@echo "âœ… Caches cleared!"

laravel-queue-restart: ## RedÃ©marre les queue workers
	@echo "ðŸ”„ Restarting queue workers..."
	@docker exec immo_guinee_app_prod php artisan queue:restart
	@echo "âœ… Queue workers restarted!"

# ==========================================
# DATABASE
# ==========================================
db-shell: ## AccÃ¨de au shell PostgreSQL
	@docker exec -it immo_guinee_postgres_prod psql -U immo_user -d immo_guinee_db

db-backup: ## CrÃ©e un backup de la base de donnÃ©es
	@echo "ðŸ’¾ Creating database backup..."
	@./scripts/backup-postgres.sh
	@echo "âœ… Backup completed!"

db-restore: ## Restaure un backup (usage: make db-restore BACKUP=backup_file.sql.gz)
	@if [ -z "$(BACKUP)" ]; then \
		echo "âŒ Usage: make db-restore BACKUP=backup_file.sql.gz"; \
		exit 1; \
	fi
	@echo "ðŸ“¥ Restoring database from $(BACKUP)..."
	@gunzip -c backups/postgres/$(BACKUP) > /tmp/restore.sql
	@docker exec -i immo_guinee_postgres_prod psql -U immo_user -d immo_guinee_db < /tmp/restore.sql
	@rm /tmp/restore.sql
	@echo "âœ… Database restored!"

# ==========================================
# MAINTENANCE
# ==========================================
backup: ## ExÃ©cute un backup complet
	@echo "ðŸ’¾ Running full backup..."
	@./scripts/backup-postgres.sh

monitor: ## ExÃ©cute le monitoring systÃ¨me
	@echo "ðŸ“Š Running system monitoring..."
	@./scripts/monitoring.sh

audit: ## ExÃ©cute l'audit de sÃ©curitÃ©
	@echo "ðŸ”’ Running security audit..."
	@./scripts/security-audit.sh

clean: ## Nettoie Docker (images, containers)
	@echo "ðŸ§¹ Cleaning Docker..."
	@docker image prune -af
	@docker container prune -f
	@echo "âœ… Docker cleaned!"

# ==========================================
# DÃ‰PLOIEMENT
# ==========================================
deploy: ## DÃ©ploie la derniÃ¨re version
	@echo "ðŸš€ Deploying latest version..."
	@git pull origin main
	@$(COMPOSE) build
	@$(COMPOSE) up -d --force-recreate
	@docker exec immo_guinee_app_prod php artisan migrate --force
	@make laravel-clear
	@make laravel-cache
	@make laravel-queue-restart
	@./scripts/cloudflare-purge.sh all || true
	@echo "âœ… Deployment completed!"

deploy-quick: ## DÃ©ploiement rapide (sans rebuild)
	@echo "âš¡ Quick deployment..."
	@git pull origin main
	@$(COMPOSE) up -d --force-recreate
	@make laravel-clear
	@make laravel-cache
	@make laravel-queue-restart
	@echo "âœ… Quick deployment completed!"

# ==========================================
# CLOUDFLARE
# ==========================================
cf-purge-all: ## Purge tout le cache Cloudflare
	@echo "ðŸ”„ Purging Cloudflare cache..."
	@./scripts/cloudflare-purge.sh all
	@echo "âœ… Cloudflare cache purged!"

# ==========================================
# TESTS
# ==========================================
test: ## Lance les tests Laravel
	@echo "ðŸ§ª Running Laravel tests..."
	@docker exec immo_guinee_app_prod php artisan test

health: ## VÃ©rifie la santÃ© des services
	@echo "ðŸ¥ Health check..."
	@curl -f http://localhost/health || echo "âŒ Nginx health check failed"
	@curl -f http://localhost/api/health || echo "âŒ Laravel health check failed"
	@curl -f http://localhost:3000/api/health || echo "âŒ Next.js health check failed"
	@echo "âœ… Health check completed!"

# ==========================================
# LOGS SPÃ‰CIFIQUES
# ==========================================
logs-nginx: ## Logs Nginx
	@$(COMPOSE) logs --tail=100 -f nginx

logs-laravel: ## Logs Laravel
	@$(COMPOSE) logs --tail=100 -f app

logs-nextjs: ## Logs Next.js
	@$(COMPOSE) logs --tail=100 -f nextjs

logs-postgres: ## Logs PostgreSQL
	@$(COMPOSE) logs --tail=100 -f postgres

logs-redis: ## Logs Redis
	@$(COMPOSE) logs --tail=100 -f redis

logs-queue: ## Logs Queue Workers
	@$(COMPOSE) logs --tail=100 -f queue

# ==========================================
# STATS
# ==========================================
stats: ## Affiche les stats Docker
	@docker stats --no-stream

disk: ## Affiche l'utilisation du disque
	@echo "ðŸ’¾ Disk usage:"
	@df -h
	@echo ""
	@echo "ðŸ“¦ Docker disk usage:"
	@docker system df

# ==========================================
# EXEMPLES D'UTILISATION
# ==========================================
# make build          # Build les images
# make up             # DÃ©marre les services
# make logs           # Affiche tous les logs
# make logs SERVICE=nginx  # Logs d'un service spÃ©cifique
# make laravel-migrate     # Migre la base de donnÃ©es
# make backup         # Backup PostgreSQL
# make deploy         # DÃ©ploie la nouvelle version
# make health         # VÃ©rifie la santÃ© des services
